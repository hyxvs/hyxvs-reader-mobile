import{_ as j,u as q,i as W,c as J,a as r,b as e,t as h,w as u,p as K,d,r as m,e as Q,o as X,f as U,q as Z}from"./index-BC7CpVgk.js";import{g as ee,a as ae,u as le,b as te,c as oe,d as se}from"./auth-Bq9qZfB1.js";import{d as ne}from"./dayjs.min-CxMP4GVf.js";import{s as i,b as re,c as x}from"./request-BWFo0bpa.js";import{s as ue}from"./function-call-CK6byjUD.js";const ie={class:"profile-page"},ve={class:"user-header"},de={class:"avatar-overlay"},ce={class:"user-info"},me={class:"logout-btn"},pe={__name:"Profile",setup(fe){const D=Q(),S=q(),l=m(null),c=m(null),y=m(null),T=K(()=>l.value&&l.value.avatar?`http://localhost:3000${l.value.avatar}`:"https://picsum.photos/80"),P=m(!1),k=m(!1),C=m(!1),f=m(!1),v=m({name:"",gender:"",email:""}),n=m({oldPassword:"",newPassword:"",confirmPassword:""}),$=[{text:"男",value:"male"},{text:"女",value:"female"}],A=t=>t?ne(t).format("YYYY-MM-DD HH:mm"):"-",B=t=>({male:"男",female:"女"})[t]||"未知",I=t=>({normal:"正常",frozen:"冻结",warning:"警告"})[t]||"未知",b=async()=>{try{const t=await ee();l.value=t.data}catch(t){console.error("获取用户信息失败:",t)}},N=async()=>{try{const t=await ae();c.value=t.data}catch(t){console.error("获取统计信息失败:",t)}},z=({selectedOptions:t})=>{v.value.gender=t[0].value,f.value=!1},M=async()=>{if(!v.value.name)return i("请输入真实姓名"),!1;if(!v.value.gender)return i("请选择性别"),!1;try{await oe(v.value),i({type:"success",message:"修改成功"}),P.value=!1,b()}catch(t){return console.error("修改个人信息失败:",t),!1}return!0},R=()=>{y.value&&y.value.click()},Y=async t=>{const a=t.target.files[0];if(!a)return;if(!a.type.startsWith("image/")){i("请选择图片文件");return}if(a.size>5*1024*1024){i("图片大小不能超过5MB");return}const w=re({message:"上传中...",forbidClick:!0,duration:0});try{const g=await le(a);x(w),i({type:"success",message:"头像上传成功"}),b()}catch(g){x(w),console.error("上传头像失败:",g),i("头像上传失败")}},E=async()=>{if(!n.value.oldPassword)return i("请输入原密码"),!1;if(!n.value.newPassword)return i("请输入新密码"),!1;if(n.value.newPassword!==n.value.confirmPassword)return i("两次输入的密码不一致"),!1;try{await se({oldPassword:n.value.oldPassword,newPassword:n.value.newPassword}),i({type:"success",message:"密码修改成功"}),k.value=!1,n.value={oldPassword:"",newPassword:"",confirmPassword:""}}catch(t){return console.error("修改密码失败:",t),!1}return!0},F=async()=>{try{await ue({title:"确认退出",message:"确定要退出登录吗？"}),await te(),S.logout(),i({type:"success",message:"退出成功"}),D.push("/login")}catch(t){t!=="cancel"&&console.error("退出失败:",t)}};return W(()=>{b(),N()}),(t,a)=>{const w=d("van-image"),g=d("van-icon"),o=d("van-cell"),G=d("van-tag"),_=d("van-cell-group"),H=d("van-button"),p=d("van-field"),V=d("van-dialog"),L=d("van-picker"),O=d("van-popup");return X(),J("div",ie,[r("div",ve,[r("div",{class:"avatar-container",onClick:R},[e(w,{round:"",width:"80",height:"80",src:T.value},null,8,["src"]),r("div",de,[e(g,{name:"camera-o",size:"20"})])]),r("input",{ref_key:"avatarInput",ref:y,type:"file",accept:"image/*",style:{display:"none"},onChange:Y},null,544),r("div",ce,[r("h3",null,h(l.value?l.value.name:"读者"),1),r("p",null,h(l.value?l.value.reader_no:""),1)])]),e(_,{inset:"",title:"个人信息"},{default:u(()=>[e(o,{title:"读者编号",value:l.value?l.value.reader_no:"-"},null,8,["value"]),e(o,{title:"真实姓名",value:l.value?l.value.name:"-"},null,8,["value"]),e(o,{title:"性别",value:l.value?B(l.value.gender):"-"},null,8,["value"]),e(o,{title:"身份证号",value:l.value&&l.value.id_card||"未设置"},null,8,["value"]),e(o,{title:"电子邮箱",value:l.value&&l.value.email||"未设置"},null,8,["value"]),e(o,{title:"信用状态"},{value:u(()=>[e(G,{type:l.value&&l.value.credit_status==="normal"?"success":"danger"},{default:u(()=>[U(h(l.value?I(l.value.credit_status):"-"),1)]),_:1},8,["type"])]),_:1}),e(o,{title:"欠费金额"},{value:u(()=>[r("span",{style:Z({color:l.value&&Number(l.value.arrears_amount)>0?"#ff4444":"#07c160"})},h(l.value?`¥${Number(l.value.arrears_amount||0).toFixed(2)}`:"¥0.00"),5)]),_:1}),e(o,{title:"注册时间",value:l.value?A(l.value.create_time):"-"},null,8,["value"])]),_:1}),e(_,{inset:"",title:"借阅统计"},{default:u(()=>[e(o,{title:"累计借阅",value:c.value?c.value.totalBorrow:"0"},null,8,["value"]),e(o,{title:"当前借阅",value:c.value?c.value.currentBorrow:"0"},null,8,["value"]),e(o,{title:"累计预约",value:c.value?c.value.totalReservation:"0"},null,8,["value"]),e(o,{title:"历史逾期",value:c.value?c.value.totalOverdue:"0"},null,8,["value"])]),_:1}),e(_,{inset:"",title:"我的服务"},{default:u(()=>[e(o,{title:"我的借阅","is-link":"",to:"/borrow",icon:"todo-list-o"}),e(o,{title:"我的预约","is-link":"",to:"/reservation",icon:"bookmark-o"}),e(o,{title:"图书查询","is-link":"",to:"/books",icon:"search"})]),_:1}),e(_,{inset:"",title:"系统设置"},{default:u(()=>[e(o,{title:"编辑个人信息","is-link":"",onClick:a[0]||(a[0]=s=>P.value=!0),icon:"edit"}),e(o,{title:"修改密码","is-link":"",onClick:a[1]||(a[1]=s=>k.value=!0),icon:"lock"}),e(o,{title:"关于系统","is-link":"",onClick:a[2]||(a[2]=s=>C.value=!0),icon:"info-o"})]),_:1}),r("div",me,[e(H,{round:"",block:"",type:"danger",onClick:F},{default:u(()=>[...a[11]||(a[11]=[U(" 退出登录 ",-1)])]),_:1})]),e(V,{show:P.value,title:"编辑个人信息","show-cancel-button":"",onConfirm:M},{default:u(()=>[e(p,{modelValue:v.value.name,"onUpdate:modelValue":a[3]||(a[3]=s=>v.value.name=s),label:"真实姓名",placeholder:"请输入真实姓名"},null,8,["modelValue"]),e(p,{modelValue:v.value.gender,"onUpdate:modelValue":a[4]||(a[4]=s=>v.value.gender=s),label:"性别",placeholder:"请选择性别",readonly:"","is-link":"",onClick:a[5]||(a[5]=s=>f.value=!0)},null,8,["modelValue"]),e(p,{modelValue:v.value.email,"onUpdate:modelValue":a[6]||(a[6]=s=>v.value.email=s),label:"电子邮箱",placeholder:"请输入电子邮箱"},null,8,["modelValue"])]),_:1},8,["show"]),e(O,{show:f.value,position:"bottom"},{default:u(()=>[e(L,{columns:$,onConfirm:z,onCancel:a[7]||(a[7]=s=>f.value=!1)})]),_:1},8,["show"]),e(V,{show:k.value,title:"修改密码","show-cancel-button":"",onConfirm:E},{default:u(()=>[e(p,{modelValue:n.value.oldPassword,"onUpdate:modelValue":a[8]||(a[8]=s=>n.value.oldPassword=s),type:"password",label:"原密码",placeholder:"请输入原密码"},null,8,["modelValue"]),e(p,{modelValue:n.value.newPassword,"onUpdate:modelValue":a[9]||(a[9]=s=>n.value.newPassword=s),type:"password",label:"新密码",placeholder:"请输入新密码"},null,8,["modelValue"]),e(p,{modelValue:n.value.confirmPassword,"onUpdate:modelValue":a[10]||(a[10]=s=>n.value.confirmPassword=s),type:"password",label:"确认密码",placeholder:"请再次输入新密码"},null,8,["modelValue"])]),_:1},8,["show"]),e(V,{show:C.value,title:"关于系统"},{default:u(()=>[...a[12]||(a[12]=[r("div",{class:"about-content"},[r("p",null,"图书馆读者系统 v1.1.0"),r("p",null,"移动端版本"),r("p",null,"© 2026 All Rights Reserved")],-1)])]),_:1},8,["show"])])}}},Pe=j(pe,[["__scopeId","data-v-d94290a1"]]);export{Pe as default};
